---
- name: Creating a user named {{ username }} on the specified machine with groups.
  user:
    name: "{{ username }}"
    state: present
    shell: /bin/bash
    groups:
      - sudo
      - docker
      - "{{ username }}"
      - plugdev
      - lxd
      - libvirt
      - kvm
      - vboxusers
    append: yes
  tags:
    - ubuntu

- name: Remove libvirt users
  become: yes
  user:
    name: "Libvirt"
    state: absent
  tags:
    - ubuntu

- name: Remove qemu users
  become: yes
  user:
    name: "Qemu"
    state: absent
  tags:
    - ubuntu

- name: Remove libvirt qemu users
  become: yes
  user:
    name: "Libvirt Qemu"
    state: absent
  tags:
    - ubuntu

# - name: Add user to sudoers list
#   lineinfile:
#     dest: /etc/sudoers
#     regexp: "{{ username }} ALL"
#     line: "{{ username }} ALL=(ALL) ALL"
#     state: present
#   notify: Start docker
#   notify: Start sshd

- name: Clone zsh
  git:
    repo: https://github.com/robbyrussell/oh-my-zsh.git
    dest: /home/{{ username }}/.oh-my-zsh
    version: master
  tags:
    - ubuntu

- name: install powerline fonts
  package:
    name: fonts-powerline
    state: present
  tags:
    - ubuntu

- name: Clone powerline fonts
  git:
    repo: https://github.com/bhilburn/powerlevel9k.git
    dest: /home/{{ username }}//.oh-my-zsh/custom/themes/powerlevel9k
    version: master
  tags:
    - ubuntu

- name: check if zsh template file exists
  stat:
    path: /home/{{ username }}/.oh-my-zsh/templates/zshrc.zsh-template
  register: check_zsh_exists
  tags:
    - ubuntu

- name: Copy default zshrc file
  copy:
    src: "/home/{{ username }}/.oh-my-zsh/templates/zshrc.zsh-template"
    dest: "/home/{{ username }}/.zshrc"
    mode: "744"
    remote_src: yes
  when: check_zsh_exists.stat.exists
  tags:
    - ubuntu

- name: Clone bash-it
  git:
    repo: https://github.com/Bash-it/bash-it.git
    dest: /home/{{ username }}/.bash-it
    version: master
  tags:
    - ubuntu

- name: Install bash-it bashrc
  shell: ~/.bash-it/install.sh
  args:
    executable: "/bin/bash"
  become_user: "{{ username }}"
  tags:
    - ubuntu

- name: copy alias and export files
  copy:
    src: "{{ item }}"
    dest: /home/{{ username }}/.{{ item }}
    mode: "744"
  with_items:
    - tmux.conf
    - source.sh
  become: yes
  become_user: "{{ username }}"
  tags:
    - ubuntu

- name: lineinfile add source.sh in bashrc
  lineinfile:
    line: source ~/.source.sh
    dest: /home/{{ username }}/.bashrc
    validate: "grep -ir 'source ~/.source.sh' %s"
  tags:
    - ubuntu

- name: lineinfile add source.sh in zshrc
  lineinfile:
    line: source ~/.source.sh
    dest: /home/{{ username }}/.zshrc
    validate: "grep -ir 'source ~/.source.sh' %s"
  tags:
    - ubuntu

- name: copy script to disable ipv6
  copy:
    src: disable-ipv6.sh
    dest: /home/{{ username }}/disable-ipv6.sh
    mode: "744"
  become: yes
  become_user: "{{ username }}"
  tags:
    - ubuntu

- name: Create ranger config directory if it does not exist
  file:
    path: /home/{{ username }}/.config/ranger
    state: directory
    mode: "0755"
  become: yes
  become_user: "{{ username }}"
  tags:
    - ubuntu

- name: copy ranger rc.conf
  copy:
    src: rifle.conf
    dest: /home/{{ username }}/.config/ranger/rifle.conf
    mode: "755"
  become: yes
  become_user: "{{ username }}"
  tags:
    - ubuntu
